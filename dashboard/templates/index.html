<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Master-Kit Global Dashboard</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --panel-2: #1f2937;
      --line: #334155;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --ok: #22c55e;
      --bad: #ef4444;
      --warn: #f59e0b;
      --accent: #0ea5e9;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      --sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      --sidebar-w: 380px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(circle at top right, #1e293b, var(--bg) 55%);
      color: var(--text);
      font-family: var(--sans);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      border-bottom: 1px solid var(--line);
      background: var(--panel);
      flex-shrink: 0;
      flex-wrap: wrap;
    }
    .header h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.2px;
      white-space: nowrap;
    }
    .header select, .header input, .header button {
      background: var(--panel-2);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 6px;
      padding: 6px 8px;
      font-family: var(--sans);
      font-size: 13px;
    }
    .header button {
      cursor: pointer;
      background: linear-gradient(180deg, #1d4ed8, #1e40af);
      border-color: #1e3a8a;
      font-weight: 600;
    }
    .header button.secondary {
      background: var(--panel-2);
      border-color: var(--line);
      font-weight: 500;
    }
    .cards {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }
    .card {
      text-align: center;
      padding: 2px 10px;
    }
    .card .k { color: var(--muted); font-size: 10px; text-transform: uppercase; }
    .card .v { font-size: 18px; font-weight: 700; }
    .ok { color: var(--ok); }
    .bad { color: var(--bad); }
    .warn { color: var(--warn); }
    #stamp { color: var(--muted); font-size: 11px; white-space: nowrap; }

    /* Main layout */
    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Left panel — DAG + run detail */
    .left-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    /* DAG area */
    .dag-area {
      flex: 1;
      overflow: auto;
      border-bottom: 1px solid var(--line);
      min-height: 200px;
      position: relative;
    }
    .dag-area svg {
      display: block;
    }
    .dag-empty {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--muted);
      font-size: 14px;
    }

    /* Run detail */
    .detail-area {
      height: 280px;
      min-height: 180px;
      overflow: auto;
      padding: 10px 14px;
      border-top: 1px solid var(--line);
      background: rgba(15, 23, 42, 0.6);
      flex-shrink: 0;
    }
    .detail-area h3 { margin: 0 0 8px; font-size: 14px; }
    .detail-area table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .detail-area th, .detail-area td {
      border-bottom: 1px solid var(--line);
      padding: 5px 6px;
      text-align: left;
      vertical-align: top;
    }
    .detail-area th {
      color: var(--muted);
      font-weight: 600;
      background: rgba(15, 23, 42, 0.55);
      position: sticky;
      top: 0;
    }
    .detail-area tbody tr:hover {
      background: rgba(30, 41, 59, 0.55);
      cursor: pointer;
    }
    .mono { font-family: var(--mono); font-size: 11px; word-break: break-all; }
    .muted { color: var(--muted); }
    .artifact-buttons {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .artifact-buttons button {
      padding: 2px 6px;
      font-size: 11px;
      background: rgba(30, 41, 59, 0.7);
      border: 1px solid var(--line);
      border-radius: 5px;
      color: var(--text);
      cursor: pointer;
    }

    /* Right sidebar — doc viewer */
    .sidebar {
      width: var(--sidebar-w);
      flex-shrink: 0;
      border-left: 1px solid var(--line);
      display: flex;
      flex-direction: column;
      background: var(--panel);
      overflow: hidden;
    }
    .sidebar-header {
      padding: 8px 12px;
      border-bottom: 1px solid var(--line);
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex-shrink: 0;
    }
    .sidebar-header h3 { margin: 0; font-size: 14px; }
    .doc-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .doc-tabs button {
      padding: 3px 8px;
      font-size: 11px;
      background: var(--panel-2);
      border: 1px solid var(--line);
      border-radius: 5px;
      color: var(--text);
      cursor: pointer;
    }
    .doc-tabs button.active {
      background: #1d4ed8;
      border-color: #1e3a8a;
    }
    .sidebar-meta {
      padding: 4px 12px;
      color: var(--muted);
      font-size: 11px;
      border-bottom: 1px solid var(--line);
      flex-shrink: 0;
    }
    .sidebar-body {
      flex: 1;
      overflow: auto;
      padding: 10px 14px;
    }
    .sidebar-body.markdown {
      font-family: var(--sans);
      font-size: 13px;
      line-height: 1.5;
    }
    .sidebar-body.markdown h1,
    .sidebar-body.markdown h2,
    .sidebar-body.markdown h3,
    .sidebar-body.markdown h4,
    .sidebar-body.markdown h5,
    .sidebar-body.markdown h6 {
      margin: 0.4em 0 0.35em;
    }
    .sidebar-body.markdown p { margin: 0.4em 0; }
    .sidebar-body.markdown ul,
    .sidebar-body.markdown ol {
      margin: 0.4em 0 0.4em 1.2em;
      padding: 0;
    }
    .sidebar-body.markdown code {
      font-family: var(--mono);
      font-size: 11px;
      background: rgba(2, 6, 23, 0.7);
      border: 1px solid var(--line);
      border-radius: 5px;
      padding: 1px 4px;
    }
    .sidebar-body.markdown pre {
      margin: 0.5em 0;
      padding: 8px;
      border: 1px solid var(--line);
      border-radius: 8px;
      overflow: auto;
      background: rgba(2, 6, 23, 0.7);
    }
    .sidebar-body.markdown pre code {
      border: 0;
      padding: 0;
      background: transparent;
    }
    .sidebar-body.text-view {
      white-space: pre-wrap;
      font-family: var(--mono);
      font-size: 11px;
    }
    .run-selected {
      outline: 1px solid var(--accent);
      background: rgba(14, 165, 233, 0.08);
    }
    .doc-tabs button.template { opacity: 0.4; }
    .json-key { color: var(--accent); }
    .json-str { color: #4ade80; }
    .json-num { color: #fbbf24; }
    .json-kw { color: var(--muted); }
    .log-error { color: var(--bad); }
    .log-warn { color: var(--warn); }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
    .dag-node circle.running { animation: pulse 1.5s ease-in-out infinite; }

    @media (max-width: 900px) {
      .main { flex-direction: column; }
      .sidebar {
        width: 100%;
        height: 300px;
        border-left: none;
        border-top: 1px solid var(--line);
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <h1>Master-Kit Dashboard</h1>
    <label>Project: <select id="project"></select></label>
    <label>Status:
      <select id="status">
        <option value="">all</option>
        <option value="running">running</option>
        <option value="ok">ok</option>
        <option value="failed">failed</option>
      </select>
    </label>
    <label>Kit:
      <select id="kit">
        <option value="">all</option>
        <option value="tdd">tdd</option>
        <option value="research">research</option>
        <option value="math">math</option>
      </select>
    </label>
    <button id="refresh-index">Reindex</button>
    <button id="reload" class="secondary">Reload</button>
    <div class="cards" id="cards"></div>
    <span id="stamp"></span>
  </div>

  <!-- Main layout -->
  <div class="main">
    <!-- Left: DAG + detail -->
    <div class="left-panel">
      <div class="dag-area" id="dag-area">
        <div class="dag-empty" id="dag-empty">Loading DAG...</div>
      </div>
      <div class="detail-area" id="detail">
        <div class="muted">Click a DAG node or run row to explore thread artifacts.</div>
      </div>
    </div>

    <!-- Right sidebar: doc viewer -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h3>State Files</h3>
        <div class="doc-tabs" id="doc-tabs"></div>
      </div>
      <div class="sidebar-meta" id="sidebar-meta">Select a project to load state files.</div>
      <div class="sidebar-body markdown" id="sidebar-body">(no file selected)</div>
    </div>
  </div>

<script>
const el = (id) => document.getElementById(id);

async function api(path, options = {}) {
  let lastErr = null;
  for (let attempt = 0; attempt < 3; attempt++) {
    try {
      const res = await fetch(path, options);
      if (!res.ok) {
        const body = await res.text();
        throw new Error(`HTTP ${res.status}: ${body}`);
      }
      return await res.json();
    } catch (err) {
      lastErr = err;
      if (attempt < 2) await new Promise(r => setTimeout(r, 150 * (attempt + 1)));
    }
  }
  throw lastErr || new Error('api request failed');
}

function qs(params) {
  const q = new URLSearchParams();
  Object.entries(params).forEach(([k, v]) => {
    if (v !== '' && v !== null && v !== undefined) q.set(k, v);
  });
  return q.toString();
}

function escapeHtml(v) {
  return String(v ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
}

function fmtStatus(s) {
  if (s === 'ok') return '<span class="ok">ok</span>';
  if (s === 'failed') return '<span class="bad">failed</span>';
  if (s === 'blocked') return '<span class="warn">blocked</span>';
  if (s === 'running') return '<span class="warn">running</span>';
  return escapeHtml(String(s || ''));
}

function basename(p) { const s = String(p||''); return s ? s.split('/').pop() || s : ''; }

function inlineMarkdown(text) {
  let out = escapeHtml(text);
  out = out.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (_m, label, href) => {
    const safe = /^(https?:\/\/|\/)/i.test(href) ? href : '#';
    return `<a href="${escapeHtml(safe)}" target="_blank" rel="noopener noreferrer">${label}</a>`;
  });
  out = out.replace(/`([^`]+)`/g, '<code>$1</code>');
  out = out.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  out = out.replace(/\*([^*]+)\*/g, '<em>$1</em>');
  return out;
}

function renderMarkdown(md) {
  const lines = String(md || '').replace(/\r\n/g, '\n').split('\n');
  const html = [];
  let inCode = false, codeLang = '', codeLines = [], inUl = false, inOl = false;
  const closeLists = () => {
    if (inUl) { html.push('</ul>'); inUl = false; }
    if (inOl) { html.push('</ol>'); inOl = false; }
  };
  const flushCode = () => {
    const cls = codeLang ? ` class="language-${escapeHtml(codeLang)}"` : '';
    html.push(`<pre><code${cls}>${escapeHtml(codeLines.join('\n'))}</code></pre>`);
    codeLines = []; codeLang = '';
  };
  for (const line of lines) {
    const fence = line.match(/^```([A-Za-z0-9_-]+)?\s*$/);
    if (fence) {
      if (inCode) { flushCode(); inCode = false; }
      else { closeLists(); inCode = true; codeLang = fence[1] || ''; codeLines = []; }
      continue;
    }
    if (inCode) { codeLines.push(line); continue; }
    if (!line.trim()) { closeLists(); continue; }
    const heading = line.match(/^(#{1,6})\s+(.*)$/);
    if (heading) { closeLists(); html.push(`<h${heading[1].length}>${inlineMarkdown(heading[2])}</h${heading[1].length}>`); continue; }
    const ul = line.match(/^\s*[-*]\s+(.*)$/);
    if (ul) { if (inOl) { html.push('</ol>'); inOl = false; } if (!inUl) { html.push('<ul>'); inUl = true; } html.push(`<li>${inlineMarkdown(ul[1])}</li>`); continue; }
    const ol = line.match(/^\s*\d+\.\s+(.*)$/);
    if (ol) { if (inUl) { html.push('</ul>'); inUl = false; } if (!inOl) { html.push('<ol>'); inOl = true; } html.push(`<li>${inlineMarkdown(ol[1])}</li>`); continue; }
    closeLists();
    html.push(`<p>${inlineMarkdown(line)}</p>`);
  }
  if (inCode) flushCode();
  closeLists();
  return html.join('\n') || '<p class="muted">(empty)</p>';
}

function renderJson(text) {
  let html = escapeHtml(text);
  html = html.replace(/&quot;([^&]+?)&quot;:/g, '<span class="json-key">&quot;$1&quot;</span>:');
  html = html.replace(/: &quot;(.*?)&quot;/g, ': <span class="json-str">&quot;$1&quot;</span>');
  html = html.replace(/: (\d+)/g, ': <span class="json-num">$1</span>');
  html = html.replace(/: (true|false|null)/g, ': <span class="json-kw">$1</span>');
  return '<pre><code class="language-json">' + html + '</code></pre>';
}

function renderLog(text) {
  const lines = String(text || '').split('\n');
  return '<pre>' + lines.map(line => {
    const esc = escapeHtml(line);
    if (/ERROR/i.test(line)) return '<span class="log-error">' + esc + '</span>';
    if (/WARN/i.test(line)) return '<span class="log-warn">' + esc + '</span>';
    return esc;
  }).join('\n') + '</pre>';
}

/* ─── DAG rendering ─── */
const STATUS_COLOR = { ok: '#22c55e', failed: '#ef4444', running: '#f59e0b', unknown: '#64748b' };

function renderDag(data) {
  const area = el('dag-area');
  if (!data.nodes || !data.nodes.length) {
    area.innerHTML = '<div class="dag-empty">No runs indexed yet. Click Reindex.</div>';
    return;
  }
  const w = Math.max(data.width || 600, 600);
  const h = Math.max(data.height || 300, 300);
  const nodeMap = {};
  data.nodes.forEach(n => { nodeMap[n.id] = n; });

  let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">`;
  svg += '<defs><marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#64748b"/></marker></defs>';

  // Edges
  for (const e of data.edges) {
    const src = nodeMap[e.source];
    const tgt = nodeMap[e.target];
    if (!src || !tgt) continue;
    const x1 = src.x + src.width;
    const y1 = src.y + src.height / 2;
    const x2 = tgt.x;
    const y2 = tgt.y + tgt.height / 2;
    const cx1 = x1 + (x2 - x1) * 0.4;
    const cx2 = x2 - (x2 - x1) * 0.4;
    const stroke = e.type === 'interop' ? '#0ea5e9' : '#475569';
    const dash = e.type === 'interop' ? ' stroke-dasharray="6 3"' : '';
    svg += `<path d="M ${x1} ${y1} C ${cx1} ${y1}, ${cx2} ${y2}, ${x2} ${y2}" fill="none" stroke="${stroke}" stroke-width="1.5"${dash} marker-end="url(#arrow)"/>`;
  }

  // Nodes
  for (const n of data.nodes) {
    const fill = STATUS_COLOR[n.status] || STATUS_COLOR.unknown;
    const tooltip = n.reasoning ? escapeHtml(n.reasoning) : '';
    svg += `<g class="dag-node" data-run-id="${escapeHtml(n.id)}" style="cursor:pointer">`;
    if (tooltip) svg += `<title>${tooltip}</title>`;
    svg += `<rect x="${n.x}" y="${n.y}" width="${n.width}" height="${n.height}" rx="8" fill="#1e293b" stroke="${fill}" stroke-width="2"/>`;
    svg += `<circle cx="${n.x + 12}" cy="${n.y + n.height / 2}" r="5" fill="${fill}"${n.status === 'running' ? ' class="running"' : ''}/>`;
    svg += `<text x="${n.x + 22}" y="${n.y + 17}" fill="#e2e8f0" font-size="11" font-family="ui-monospace,monospace">${escapeHtml(n.label)}</text>`;
    if (n.status === 'running' && n.started_at) {
      const elapsed = Math.floor((Date.now() - new Date(n.started_at).getTime()) / 1000);
      const mm = Math.floor(elapsed / 60);
      const ss = elapsed % 60;
      svg += `<text x="${n.x + 22}" y="${n.y + 32}" fill="#f59e0b" font-size="9" font-family="ui-monospace,monospace">${mm}m ${ss}s</text>`;
    } else {
      svg += `<text x="${n.x + 22}" y="${n.y + 32}" fill="#94a3b8" font-size="9" font-family="ui-monospace,monospace">${escapeHtml(n.id.length > 20 ? n.id.slice(0,20)+'...' : n.id)}</text>`;
    }
    svg += '</g>';
  }

  svg += '</svg>';
  area.innerHTML = svg;

  // Click handler on nodes
  area.querySelectorAll('.dag-node').forEach(g => {
    g.addEventListener('click', () => {
      const runId = g.getAttribute('data-run-id');
      const node = nodeMap[runId];
      if (node) loadRunDetail(el('project').value || findProjectForRun(runId), runId);
    });
  });
}

function findProjectForRun(runId) {
  // fallback — pick first project
  const sel = el('project');
  if (sel.value) return sel.value;
  if (sel.options.length > 1) return sel.options[1].value;
  return '';
}

/* ─── Sidebar doc viewer ─── */
const docState = { projectId: '', path: '', scope: 'project' };

function preferredProjectId() {
  const v = el('project').value;
  if (v) return v;
  const sel = el('project');
  if (sel.options.length > 1) return sel.options[1].value;
  return '';
}

async function loadProjectDocs(force) {
  const pid = preferredProjectId();
  docState.projectId = pid;
  const tabs = el('doc-tabs');
  const meta = el('sidebar-meta');
  const body = el('sidebar-body');
  if (!pid) {
    tabs.innerHTML = '';
    meta.textContent = 'Select a project.';
    body.classList.add('markdown');
    body.innerHTML = '(no project)';
    return;
  }
  const payload = await api(`/api/project-docs?${qs({project_id: pid})}`);
  const docs = Array.isArray(payload.docs) ? payload.docs : [];
  const existing = docs.filter(d => d && d.exists && d.path);
  if (!existing.length) {
    tabs.innerHTML = '<span class="muted">No state files found.</span>';
    meta.textContent = `project ${pid}`;
    body.innerHTML = '(no files)';
    return;
  }
  const populated = existing.filter(d => d.populated !== false);
  const unpopulated = existing.filter(d => d.populated === false);
  const makeBtn = (d, cls) => {
    const p = String(d.path||'');
    const s = String(d.scope||'project');
    return `<button data-path="${escapeHtml(p)}" data-scope="${escapeHtml(s)}" data-populated="${d.populated !== false ? 'true' : 'false'}"${cls ? ' class="'+cls+'"' : ''}>${escapeHtml(d.name||p)}</button>`;
  };
  tabs.innerHTML = populated.map(d => makeBtn(d, '')).join('') + unpopulated.map(d => makeBtn(d, 'template')).join('');
  const mustReset = force || !docState.path || !populated.some(d => String(d.path) === docState.path);
  if (mustReset) {
    if (populated.length) {
      const preferred = populated.find(d => ['LAST_TOUCH.md','DOMAIN_PRIORS.md','CONSTRUCTION_LOG.md'].includes(String(d.name||''))) || populated[0];
      docState.path = String(preferred.path||'');
      docState.scope = String(preferred.scope||'project');
    } else {
      docState.path = '';
      meta.textContent = `project ${pid}`;
      body.className = 'sidebar-body markdown';
      body.innerHTML = '<p class="muted">State files exist but are not yet populated.</p>';
      return;
    }
  }
  highlightDocTab();
  if (docState.path) await loadDocContent();
}

function highlightDocTab() {
  el('doc-tabs').querySelectorAll('button').forEach(btn => {
    btn.classList.toggle('active', btn.getAttribute('data-path') === docState.path);
  });
}

async function loadDocContent() {
  if (!docState.projectId || !docState.path) return;
  const payload = await api(`/api/artifact?${qs({
    project_id: docState.projectId,
    path: docState.path,
    scope: docState.scope,
    max_bytes: 220000,
  })}`);
  const meta = el('sidebar-meta');
  const body = el('sidebar-body');
  const trunc = payload.truncated ? ' (truncated)' : '';
  meta.textContent = `${payload.path} \u2022 ${payload.bytes_read}/${payload.bytes_total}b${trunc}`;
  if (payload.kind === 'markdown') {
    body.className = 'sidebar-body markdown';
    body.innerHTML = renderMarkdown(payload.text || '');
  } else {
    body.className = 'sidebar-body text-view';
    body.textContent = payload.text || '';
  }
}

el('doc-tabs').addEventListener('click', async (evt) => {
  const btn = evt.target.closest('button');
  if (!btn) return;
  docState.path = btn.getAttribute('data-path') || '';
  docState.scope = btn.getAttribute('data-scope') || 'project';
  highlightDocTab();
  if (btn.getAttribute('data-populated') === 'false') {
    el('sidebar-meta').textContent = docState.path;
    const body = el('sidebar-body');
    body.className = 'sidebar-body markdown';
    body.innerHTML = '<p class="muted">Template \u2014 not yet populated</p>';
    return;
  }
  await safeRefresh(loadDocContent);
});

/* ─── Projects, summary, DAG loading ─── */
async function loadProjects() {
  const sel = el('project');
  sel.innerHTML = '';
  const all = document.createElement('option');
  all.value = ''; all.textContent = 'all projects';
  sel.appendChild(all);
  const payload = await api('/api/projects');
  for (const p of payload.projects) {
    const opt = document.createElement('option');
    opt.value = p.project_id;
    opt.textContent = `${p.label} [${p.project_id}]`;
    sel.appendChild(opt);
  }
}

function card(label, value, klass) {
  return `<div class="card"><div class="k">${label}</div><div class="v ${klass||''}">${value??0}</div></div>`;
}

async function loadSummary() {
  const pid = el('project').value;
  const s = await api(`/api/summary?${qs({project_id: pid})}`);
  const r = s.summary.runs || {};
  const q = s.summary.requests || {};
  el('cards').innerHTML = [
    card('runs', r.total_runs||0),
    card('ok', r.ok_runs||0, 'ok'),
    card('fail', r.failed_runs||0, 'bad'),
    card('active', r.running_runs||0, 'warn'),
    card('reqs', q.total_requests||0),
    card('blocked', q.blocked_requests||0, 'warn'),
  ].join('');
}

async function loadDag() {
  const pid = el('project').value;
  const data = await api(`/api/dag?${qs({project_id: pid})}`);
  renderDag(data);
}

/* ─── Run detail ─── */
function artifactBtn(pid, path, label, runId) {
  if (!path) return '';
  return `<button class="artifact-btn" data-pid="${escapeHtml(pid)}" data-path="${escapeHtml(path)}" data-run="${escapeHtml(runId||'')}">${escapeHtml(label)}</button>`;
}

async function loadRunDetail(projectId, runId) {
  if (!projectId || !runId) return;
  const payload = await api(`/api/run?${qs({project_id: projectId, run_id: runId})}`);
  const sel = payload.run || {};
  const runsRows = (payload.thread_runs||[]).map(r => {
    const rid = String(r.run_id||'');
    const btns = [
      artifactBtn(projectId, r.capsule_path, basename(r.capsule_path)||'capsule', rid),
      artifactBtn(projectId, r.manifest_path, basename(r.manifest_path)||'manifest', rid),
      artifactBtn(projectId, r.log_path, basename(r.log_path)||'log', rid),
      artifactBtn(projectId, r.events_path, basename(r.events_path)||'events', rid),
    ].filter(Boolean).join('');
    const reasoningTip = r.reasoning ? ` title="${escapeHtml(r.reasoning)}"` : '';
    return `<tr data-thread-run-id="${escapeHtml(rid)}"${reasoningTip}><td class="mono">${escapeHtml(rid)}</td><td>${fmtStatus(r.status)}</td><td>${escapeHtml((r.kit||'?')+'.'+(r.phase||'?'))}</td><td class="mono">${escapeHtml(r.parent_run_id||'')}</td><td class="mono">${escapeHtml(r.started_at||'')}</td><td>${r.reasoning ? '<span class="muted" style="font-size:10px;margin-right:4px" title="'+escapeHtml(r.reasoning)+'">R</span>' : ''}${btns||'<span class="muted">-</span>'}</td></tr>`;
  }).join('');

  const reqRows = (payload.thread_requests||[]).map(r => {
    const rTip = r.reasoning ? ` title="${escapeHtml(r.reasoning)}"` : '';
    return `<tr${rTip}><td class="mono">${escapeHtml(r.request_id||'')}</td><td>${fmtStatus(r.status)}</td><td class="mono">${escapeHtml((r.from_kit||'?')+'.'+(r.from_phase||'?')+' -> '+(r.to_kit||'?')+'.'+(r.to_phase||'?'))}</td><td class="mono">${escapeHtml(r.child_run_id||'')}</td><td class="muted" style="font-size:10px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(r.reasoning||'')}</td></tr>`;
  }).join('');

  const detail = el('detail');
  const selReasoning = sel.reasoning ? `<div class="muted" style="font-size:11px;margin-bottom:6px"><strong>Reasoning:</strong> ${escapeHtml(sel.reasoning)}</div>` : '';
  detail.innerHTML = `
    <h3>Thread ${escapeHtml(payload.thread_root_run_id||'')} &mdash; ${escapeHtml((sel.kit||'?')+'.'+(sel.phase||'?'))} ${fmtStatus(sel.status)}</h3>${selReasoning}
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div>
        <div style="max-height:150px;overflow:auto;border:1px solid var(--line);border-radius:6px">
          <table><thead><tr><th>run</th><th>st</th><th>phase</th><th>parent</th><th>start</th><th>artifacts</th></tr></thead>
          <tbody>${runsRows||'<tr><td colspan="6" class="muted">No runs.</td></tr>'}</tbody></table>
        </div>
        ${reqRows ? `<div style="margin-top:8px;max-height:120px;overflow:auto;border:1px solid var(--line);border-radius:6px"><table><thead><tr><th>request</th><th>st</th><th>edge</th><th>child</th><th>reasoning</th></tr></thead><tbody>${reqRows}</tbody></table></div>` : ''}
      </div>
      <div>
        <div id="artifact-meta" class="muted" style="font-size:11px;margin-bottom:4px">Click an artifact button.</div>
        <div id="artifact-body" class="sidebar-body text-view" style="max-height:240px;overflow:auto;border:1px solid var(--line);border-radius:6px;padding:8px">(no artifact)</div>
      </div>
    </div>`;

  // Highlight selected run in DAG
  el('dag-area').querySelectorAll('.dag-node rect').forEach(rect => {
    const g = rect.parentElement;
    if (g.getAttribute('data-run-id') === runId) {
      rect.setAttribute('stroke-width', '3');
    }
  });
}

// Artifact click in detail area
el('detail').addEventListener('click', async (evt) => {
  const btn = evt.target.closest('.artifact-btn');
  if (!btn) return;
  evt.preventDefault();
  const pid = btn.getAttribute('data-pid') || '';
  const path = btn.getAttribute('data-path') || '';
  if (!pid || !path) return;
  const payload = await api(`/api/artifact?${qs({project_id: pid, path: path, max_bytes: 220000})}`);
  const meta = el('artifact-meta');
  const body = el('artifact-body');
  if (!meta || !body) return;
  const trunc = payload.truncated ? ' (truncated)' : '';
  meta.textContent = `${payload.path} \u2022 ${payload.kind} \u2022 ${payload.bytes_read}/${payload.bytes_total}b${trunc}`;
  body.style.maxHeight = '240px';
  if (payload.kind === 'markdown') {
    body.className = 'sidebar-body markdown';
    body.innerHTML = renderMarkdown(payload.text || '');
  } else if (payload.kind === 'json' || payload.kind === 'jsonl') {
    body.className = 'sidebar-body';
    body.innerHTML = renderJson(payload.text || '');
  } else if (payload.path && payload.path.endsWith('.log')) {
    body.className = 'sidebar-body';
    body.innerHTML = renderLog(payload.text || '');
  } else {
    body.className = 'sidebar-body text-view';
    body.textContent = payload.text || '';
  }
});

/* ─── Load all + events ─── */
async function loadAll() {
  await Promise.all([loadSummary(), loadDag(), loadProjectDocs()]);
  el('stamp').textContent = `updated ${new Date().toLocaleTimeString()}`;
}

async function safeRefresh(fn) {
  try { await fn(); } catch (err) {
    el('stamp').textContent = `error: ${err.message || err}`;
    console.error(err);
  }
}

el('refresh-index').addEventListener('click', async () => {
  await safeRefresh(async () => {
    const pid = el('project').value;
    await api('/api/refresh', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(pid ? {project_id: pid} : {}),
    });
    await loadAll();
  });
});
el('reload').addEventListener('click', () => safeRefresh(loadAll));
el('project').addEventListener('change', async () => {
  el('detail').innerHTML = '<div class="muted">Click a DAG node or run row to explore.</div>';
  docState.path = '';
  await safeRefresh(loadAll);
});
el('status').addEventListener('change', () => safeRefresh(loadDag));
el('kit').addEventListener('change', () => safeRefresh(loadDag));

(async function boot() {
  await safeRefresh(async () => {
    await loadProjects();
    await loadAll();
  });
  setInterval(() => { void safeRefresh(loadDocContent); }, 5000);
  let _prevRunning = 0;
  setInterval(async () => {
    try {
      const pid = el('project').value;
      const s = await api(`/api/summary?${qs({project_id: pid})}`);
      const running = s.summary?.runs?.running_runs || 0;
      if (running > 0 || _prevRunning > 0) {
        await loadAll();
      }
      _prevRunning = running;
    } catch (_) {}
  }, 3000);
})();
</script>
</body>
</html>
